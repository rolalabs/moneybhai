name: Database Migration

on:
  workflow_dispatch:
    inputs:
      migration_action:
        description: 'Migration action to perform'
        required: true
        default: 'upgrade'
        type: choice
        options:
        - upgrade
        - downgrade
        - current
        - history
      target_revision:
        description: 'Target revision (for downgrade, optional for upgrade)'
        required: false
        default: 'head'

env:
  PROJECT_ID: rola-labs
  REGION: asia-south1

jobs:
  migrate:
    runs-on: ubuntu-latest
    environment: development

    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install alembic psycopg2-binary python-dotenv pydantic-settings sqlalchemy

      - name: Create .env file
        run: |
          cat <<EOF > .env
          DATABASE_URL="${{ secrets.DATABASE_URL }}"
          GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}"
          WORKER_CLOUD_RUN_URL="${{ vars.WORKER_CLOUD_RUN_URL }}"
          API_TOKEN_GITHUB="${{ secrets.API_TOKEN_GITHUB }}"
          GCP_CREDENTIALS='${{ secrets.GCP_CREDENTIALS }}'
          EOF

      - name: Show current migration status
        run: alembic current

      - name: Show migration history
        if: inputs.migration_action == 'history'
        run: alembic history

      - name: Run migration upgrade
        if: inputs.migration_action == 'upgrade'
        run: alembic upgrade ${{ inputs.target_revision }}

      - name: Run migration downgrade
        if: inputs.migration_action == 'downgrade'
        run: alembic downgrade ${{ inputs.target_revision }}

      - name: Show final migration status
        run: alembic current