name: Test Cloud SQL Connection

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: rola-labs
  REGION: asia-south1

jobs:
  test-connection:
    runs-on: ubuntu-latest
    environment: development

    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary sqlalchemy

      - name: Test Database Connection
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python -c "
          import os
          from sqlalchemy import create_engine, text
          
          print('Testing database connection...')
          
          try:
              engine = create_engine(os.environ['DATABASE_URL'], echo=True)
              
              with engine.connect() as conn:
                  result = conn.execute(text('SELECT version()'))
                  version = result.scalar()
                  print(f'‚úÖ Connection successful!')
                  print(f'PostgreSQL version: {version}')
                  
                  # Test schema existence
                  result = conn.execute(text(
                      \"SELECT schema_name FROM information_schema.schemata WHERE schema_name = 'moneybhai'\"
                  ))
                  schema = result.scalar()
                  if schema:
                      print(f'‚úÖ Schema \"moneybhai\" exists')
                  else:
                      print(f'‚ö†Ô∏è  Schema \"moneybhai\" not found')
                  
                  # Test table count
                  result = conn.execute(text(
                      \"SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'moneybhai'\"
                  ))
                  table_count = result.scalar()
                  print(f'üìä Found {table_count} tables in moneybhai schema')
                  
              print('‚úÖ All connection tests passed!')
              
          except Exception as e:
              print(f'‚ùå Connection failed: {e}')
              exit(1)
          "

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Database connection test failed!"
